<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" type="image/png" href="/images/logo/favicon.png" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" />
    <title>Contact - Rolnopol</title>
    <link rel="stylesheet" href="/css/styles.css" />
    <style>
      /* Page-scoped adjustments for Contact page */
      body.contact-page .main {
        padding-top: 0;
      }

      .contact-form {
        display: flex;
        flex-direction: column;
        gap: 1rem;
        margin: 25px;
      }

      .form-group {
        display: flex;
        flex-direction: column;
      }

      .form-label-modern {
        font-weight: bold;
        margin-bottom: 0.5rem;
      }

      .form-input-modern {
        padding: 0.5rem;
        border: 1px solid #ccc;
        border-radius: 4px;
      }

      .form-input-modern:focus {
        border-color: #007bff;
        outline: none;
      }

      .form-button {
        padding: 0.5rem 1rem;
        background-color: #007bff;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }

      .form-button:disabled {
        background-color: #ccc;
      }

      /* Small muted note under the send button */
      .contact-note {
        margin-left: 0;
        display: flex;
        justify-content: flex-end;
      }

      .contact-note .note-text {
        color: #6a7b5e;
        font-size: 0.7rem;
        opacity: 0.9;
        font-style: italic;
        line-height: 1;
        width: 250px;
        text-align: left !important;
      }

      .contact-disabled {
        display: none;
        padding: 1.5rem;
        border-radius: 0.8rem;
        background: rgba(106, 123, 94, 0.08);
        border: 1px dashed rgba(106, 123, 94, 0.35);
        color: #2d3a2d;
      }

      .contact-disabled h3 {
        margin-top: 0;
      }
    </style>
  </head>

  <body class="bg-agri-pattern contact-page">
    <!-- Dynamic Header Component -->
    <div id="header-component"></div>

    <div class="container" style="margin-top: 0rem; padding: 1rem">
      <header
        class="header glass"
        style="
          display: flex;
          flex-direction: column;
          align-items: center;
          justify-content: center;
          padding: 0.9rem 0 1rem 0;
          margin-bottom: 1.2rem;
          box-shadow: 0 2px 12px rgba(0, 0, 0, 0.07);
          border-radius: 1rem 1rem 0 0;
        "
      >
        <div style="display: flex; align-items: center; gap: 1rem; width: 100%; justify-content: center">
          <h1 style="display: flex; align-items: center; gap: 0.5rem; font-size: 1.75rem">
            <span class="bg-agri-gradient"><i class="fas fa-envelope"></i></span>
          </h1>
          <div style="display: flex; flex-direction: column; align-items: flex-start">
            <span class="main-title" style="font-size: 1.75rem">Contact Us</span>
            <span style="font-size: 0.95rem; color: #6a7b5e; font-weight: 400; margin-top: 0.1rem">We'd love to hear from you</span>
          </div>
        </div>
      </header>

      <main class="main">
        <!-- Contact Form -->
        <section class="glass futuristic-card">
          <div id="contact-disabled" class="contact-disabled" role="status" aria-live="polite">
            <h3>Contact form is currently disabled</h3>
            <p>Please check back later or use another channel.</p>
          </div>
          <form class="contact-form" id="contactForm" novalidate>
            Have a question, feedback or idea? Send us a message!

            <div class="form-grid-modern" style="gap: 1rem">
              <div class="form-group">
                <label for="name" class="form-label-modern"> <i class="fas fa-user"></i> Your name </label>
                <input id="name" name="name" type="text" class="form-input-modern" placeholder="Jane Doe" autocomplete="name" required />
              </div>

              <div class="form-group">
                <label for="email" class="form-label-modern"> <i class="fas fa-envelope"></i> Email </label>
                <input
                  id="email"
                  name="email"
                  type="email"
                  class="form-input-modern"
                  placeholder="jane@example.com"
                  autocomplete="email"
                  required
                />
              </div>

              <div class="form-group" style="grid-column: 1 / -1">
                <label for="subject" class="form-label-modern"> <i class="fas fa-tag"></i> Subject </label>
                <input id="subject" name="subject" type="text" class="form-input-modern" placeholder="How can we help?" required />
              </div>

              <div class="form-group description-group" style="grid-column: 1 / -1">
                <label for="message" class="form-label-modern"> <i class="fas fa-message"></i> Message </label>
                <textarea
                  id="message"
                  name="message"
                  class="form-input-modern"
                  placeholder="Write your message here..."
                  rows="6"
                  required
                ></textarea>
              </div>
            </div>

            <div class="contact-note" aria-hidden="true">
              <small class="note-text"
                >Note: This contact form is for testing purposes only and does not send messages to a real inbox!</small
              >
            </div>
            <div style="display: flex; gap: 0.6rem; justify-content: flex-end">
              <button type="reset" class="btn btn-outline btn-compact"><i class="fas fa-eraser"></i> Clear</button>
              <button id="sendBtn" type="submit" class="btn btn-agri btn-compact"><i class="fas fa-paper-plane"></i> Send Message</button>
            </div>
          </form>
        </section>
      </main>

      <div id="footer-component"></div>
    </div>

    <!-- Core Dependencies -->
    <script src="/js/core/event-bus.js"></script>
    <script src="/js/core/storage.js"></script>
    <script src="/js/core/app.js"></script>

    <!-- Services -->
    <script src="/js/services/api-service.js"></script>
    <script src="/js/services/auth-service.js"></script>
    <script src="/js/services/feature-flags-service.js"></script>

    <!-- Components -->
    <script src="/js/components/notification.js"></script>
    <script src="/js/components/navigation.js"></script>
    <script src="/js/components/form.js"></script>
    <script src="/js/components.js"></script>

    <!-- API Functions -->
    <script src="/js/api.js"></script>

    <!-- Utilities -->
    <script src="/js/utils/error-logger.js"></script>
    <script src="/js/utils/utils.js"></script>
    <script src="/js/utils/router.js"></script>
    <script src="/js/utils/global-compat.js"></script>

    <!-- Main Application -->
    <script src="/js/app.js"></script>
    <script src="/js/utils/init-navigation.js"></script>
    <script>
      // Initialize header/footer and nav highlight
      initNavigation("contact");

      const waitForAppInit = async () => {
        if (!window.App) {
          return false;
        }
        if (window.App.isInitialized) {
          return true;
        }

        const maxAttempts = 120;
        let attempts = 0;

        while (attempts < maxAttempts) {
          if (window.App.isInitialized) {
            return true;
          }
          await new Promise((resolve) => setTimeout(resolve, 50));
          attempts += 1;
        }

        return window.App.isInitialized === true;
      };

      const getContactFlagValue = async () => {
        const ready = await waitForAppInit();
        if (!ready) {
          return false;
        }

        const service = window.App?.getModule?.("featureFlagsService");
        if (!service || typeof service.isEnabled !== "function") {
          return false;
        }

        return service.isEnabled("contactFormEnabled", false);
      };

      const setContactFormState = (enabled) => {
        const formEl = document.getElementById("contactForm");
        const disabledEl = document.getElementById("contact-disabled");
        if (formEl) {
          formEl.style.display = enabled ? "" : "none";
        }
        if (disabledEl) {
          disabledEl.style.display = enabled ? "none" : "block";
        }
      };

      // Setup the contact form
      document.addEventListener("DOMContentLoaded", async function () {
        const enabled = await getContactFlagValue();
        setContactFormState(enabled);
        if (!enabled) {
          return;
        }

        const formEl = document.getElementById("contactForm");
        if (!formEl) return;

        const form = new FormComponent(formEl, {
          validateOnBlur: true,
          validateOnInput: true,
        });

        // Validators
        form.addValidator("name", (v) => {
          if (!v || v.trim().length < 2) return "Please enter your name";
          return null;
        });
        form.addValidator("email", (v) => {
          if (!v) return "Email is required";
          const re = /[^\s@]+@[^\s@]+\.[^\s@]+/;
          return re.test(v) ? null : "Enter a valid email";
        });
        form.addValidator("subject", (v) => {
          if (!v || v.trim().length < 3) return "Subject is too short";
          return null;
        });
        form.addValidator("message", (v) => {
          if (!v || v.trim().length < 10) return "Message should be at least 10 characters";
          return null;
        });

        form.onSubmit(async (data, fc) => {
          try {
            const btn = document.getElementById("sendBtn");
            btn.disabled = true;

            // Use ApiService to call backend endpoint
            const api = window.App && window.App.getModule ? window.App.getModule("apiService") : null;
            let result;
            if (api && typeof api.post === "function") {
              result = await api.post("contact", data, { throwOnError: false });
            } else {
              // Fallback fetch if module not ready
              const res = await fetch("/api/v1/contact", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(data),
              });
              const json = await res.json();
              result = { success: res.ok && json.success !== false, data: json, status: res.status, error: json.error };
            }

            if (result && result.success) {
              const msg =
                result.data && (result.data.message || result.data.success) ? result.data.message || "Message sent" : "Message sent";
              if (window.App && window.App.getEventBus) {
                window.App.getEventBus().emit("notification:show", { message: `Thanks! ${msg}.`, type: "success", duration: 6000 });
              } else if (window.showNotification) {
                window.showNotification(`Thanks! ${msg}.`, "success", 6000);
              }
              fc.reset();
            } else {
              const errText = (result && (result.error || (result.data && result.data.error))) || "Failed to send message";
              if (window.App && window.App.getEventBus) {
                window.App.getEventBus().emit("notification:show", { message: errText, type: "error", duration: 7000 });
              } else if (window.showNotification) {
                window.showNotification(errText, "error", 7000);
              }
            }
            btn.disabled = false;
          } catch (error) {
            if (window.errorLogger) errorLogger.log("Contact Form", error, { showToUser: true });
            const btn = document.getElementById("sendBtn");
            if (btn) btn.disabled = false;
          }
        });
      });
    </script>
  </body>
</html>
