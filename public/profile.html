<!doctype html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" type="image/png" href="/images/logo/favicon.png" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" />
  <title>Profile - Rolnopol</title>
  <link rel="stylesheet" href="/css/styles.css" />
</head>

<body class="bg-agri-pattern">
  <!-- Dynamic Header Component -->
  <div id="header-component" data-testid="header-component"></div>

  <div class="container" style="margin-top: 0rem; padding: 1rem" data-testid="profile-container">
    <header class="header glass" style="
          display: flex;
          flex-direction: column;
          align-items: center;
          justify-content: center;
          padding: 0.75rem 0 1rem 0;
          margin-bottom: 1.5rem;
          box-shadow: 0 2px 12px rgba(0, 0, 0, 0.07);
          border-radius: 1rem 1rem 0 0;
        ">
      <div style="
            display: flex;
            align-items: center;
            gap: 1rem;
            width: 100%;
            justify-content: center;
          ">
        <h1 style="
              display: flex;
              align-items: center;
              gap: 0.5rem;
              font-size: 1.75rem;
            ">
          <span class="bg-agri-gradient"><i class="fas fa-tractor"></i></span>
        </h1>
        <div style="
              display: flex;
              flex-direction: column;
              align-items: flex-start;
            ">
          <span class="main-title" style="font-size: 1.75rem">Rolnopol</span>
          <span style="
                font-size: 0.9rem;
                color: #6a7b5e;
                font-weight: 400;
                margin-top: 0.1rem;
              ">User Profile & Farm Management</span>
        </div>
      </div>
    </header>

    <main class="main">
      <div class="profile-container-modern" data-testid="profile-container-modern">
        <!-- Compact Profile Header -->
        <div class="profile-header-modern glass fade-in" data-testid="profile-header">
          <div class="profile-header-left">
            <div class="profile-avatar-modern">
              <div class="avatar-circle-modern futuristic">
                <i class="fas fa-user-astronaut"></i>
              </div>
            </div>
            <div class="profile-header-info">
              <h2 id="profileName" class="profile-name-modern">Loading...</h2>
              <p id="profileEmail" class="profile-email-modern">Loading...</p>
              <span id="statusBadge" class="status-badge-modern">
                <i class="fas fa-circle"></i>
                <span id="statusText">Loading...</span>
              </span>
            </div>
          </div>
          <div class="profile-header-actions">
            <button id="logout-btn" class="btn btn-compact btn-futuristic" data-testid="logout-btn">
              <i class="fas fa-sign-out-alt"></i>
              Logout
            </button>
          </div>
        </div>

        <!-- Loading State -->
        <div id="loadingMessage" class="loading-card-modern glass" data-testid="loading-message">
          <div class="loading-spinner futuristic-loader"></div>
          <p>Loading profile information...</p>
        </div>

        <!-- Error State -->
        <div id="errorMessage" class="error-card-modern glass" style="display: none" data-testid="error-message">
          <div class="error-icon-modern">
            <i class="fas fa-exclamation-triangle"></i>
          </div>
          <div class="error-content-modern">
            <h3>Error Loading Profile</h3>
            <p id="errorText">
              An error occurred while loading your profile.
            </p>
            <button class="btn btn-compact btn-agri" onclick="location.reload()">
              <i class="fas fa-redo"></i>
              Try Again
            </button>
          </div>
        </div>

        <!-- Profile Content -->
        <div id="profileContent" style="display: none" data-testid="profile-content">
          <div class="profile-grid-modern">
            <!-- Profile Information Card -->
            <div class="profile-card-modern futuristic-card">
              <div class="card-header-modern futuristic" style="
                    display: flex;
                    align-items: center;
                    justify-content: space-between;
                    gap: 1rem;
                  ">
                <h3 style="
                      margin: 0;
                      display: flex;
                      align-items: center;
                      gap: 0.5rem;
                    ">
                  <i class="fas fa-info-circle"></i>
                  Profile Information
                </h3>
                <button id="editProfileInfoBtn" class="btn btn-compact btn-outline btn-futuristic" aria-label="Edit profile information" title="Edit profile information">
                  <i class="fas fa-pencil-alt"></i>
                  Edit
                </button>
              </div>
              <div class="card-content-modern">
                <div class="info-grid-modern">
                  <div class="info-item-modern">
                    <div class="info-label-modern">
                      <i class="fas fa-id-card"></i>
                      User ID
                    </div>
                    <div class="info-value-modern" id="userId" data-testid="user-id">-</div>
                  </div>
                  <div class="info-item-modern">
                    <div class="info-label-modern">
                      <i class="fas fa-user"></i>
                      Display Name
                    </div>
                    <div class="info-value-modern" id="displayedName" data-testid="displayed-name">-</div>
                    <div class="edit-field-modern" id="editDisplayedNameGroup" style="display: none; margin-top: 0.5rem">
                      <input type="text" id="inlineDisplayedName" class="form-input-modern" placeholder="Enter display name" minlength="3" maxlength="20" aria-label="Display name" />
                      <div class="form-help-modern">
                        <i class="fas fa-info-circle"></i> 3-20 characters;
                        letters, numbers, spaces, -, _
                      </div>
                      <div class="form-error hide" id="inlineDisplayedNameError" role="alert"></div>
                    </div>
                  </div>
                  <div class="info-item-modern">
                    <div class="info-label-modern">
                      <i class="fas fa-envelope"></i>
                      Email Address
                    </div>
                    <div class="info-value-modern" id="email" data-testid="email-value">-</div>
                    <div class="edit-field-modern" id="editEmailGroup" style="display: none; margin-top: 0.5rem">
                      <input type="email" id="inlineEmail" class="form-input-modern" placeholder="Enter email address" aria-label="Email address" />
                      <div class="form-help-modern">
                        <i class="fas fa-info-circle"></i> Leave empty to keep
                        current email
                      </div>
                      <div class="form-error hide" id="inlineEmailError" role="alert"></div>
                    </div>
                  </div>
                  <div class="info-item-modern">
                    <div class="info-label-modern">
                      <i class="fas fa-calendar-plus"></i>
                      Account Created
                    </div>
                    <div class="info-value-modern" id="createdAt" data-testid="created-at">-</div>
                  </div>
                  <div class="info-item-modern">
                    <div class="info-label-modern">
                      <i class="fas fa-clock"></i>
                      Last Login
                    </div>
                    <div class="info-value-modern" id="lastLogin" data-testid="last-login">-</div>
                  </div>
                </div>
                <div id="inlineEditActions" style="
                      display: none;
                      margin-top: 1rem;
                      gap: 0.75rem;
                      justify-content: flex-end;
                    ">
                  <div id="inlineEditMessage" class="message-modern" style="display: none; margin-right: auto"></div>
                  <button id="editProfileCancel" class="btn btn-compact btn-outline btn-earth" type="button" data-testid="edit-profile-cancel">
                    <i class="fas fa-times"></i>
                    Cancel
                  </button>
                  <button id="editProfileSave" class="btn btn-compact btn-futuristic" type="button" data-testid="edit-profile-save">
                    <i class="fas fa-save"></i>
                    Save
                  </button>
                </div>
              </div>
            </div>

            <!-- Update Profile Card -->
            <div class="profile-card-modern futuristic-card">
              <div class="card-header-modern futuristic">
                <h3>
                  <i class="fas fa-edit"></i>
                  Update Profile
                </h3>
              </div>
              <div class="card-content-modern">
                <form id="updateProfileForm" class="update-form-modern">
                  <div class="form-group-modern">
                    <label for="newDisplayedName" class="form-label-modern">
                      <i class="fas fa-user"></i>
                      Display Name
                    </label>
                    <input type="text" id="newDisplayedName" name="newDisplayedName" class="form-input-modern" placeholder="Enter your display name" minlength="3" maxlength="20" required data-testid="new-displayed-name-input" />
                    <div class="form-meta-modern">
                      <div class="form-help-modern">
                        <i class="fas fa-info-circle"></i>
                        3-20 characters
                      </div>
                      <div class="char-counter-modern">
                        <span class="current" id="displayedNameCharCount">0</span>/20
                      </div>
                    </div>
                    <div class="form-error hide" id="displayedNameError" data-testid="new-displayed-name-error">
                      <i class="fas fa-exclamation-circle"></i>
                      <span id="displayedNameErrorText"></span>
                    </div>
                    <div class="form-success hide" id="displayedNameSuccess" data-testid="new-displayed-name-success">
                      <i class="fas fa-check-circle"></i>
                      <span>Display name is valid</span>
                    </div>
                  </div>

                  <div class="form-group-modern">
                    <label for="newPassword" class="form-label-modern">
                      <i class="fas fa-lock"></i>
                      New Password
                    </label>
                    <input type="password" id="newPassword" name="newPassword" class="form-input-modern" placeholder="Leave blank to keep current" minlength="3" maxlength="50" data-testid="new-password-input" />
                    <div class="form-meta-modern">
                      <div class="form-help-modern">
                        <i class="fas fa-shield-alt"></i>
                        Min 3 characters
                      </div>
                      <div class="char-counter-modern">
                        <span class="current" id="passwordCharCount">0</span>/50
                      </div>
                    </div>
                    <div class="form-error hide" id="passwordError" data-testid="new-password-error">
                      <i class="fas fa-exclamation-circle"></i>
                      <span id="passwordErrorText"></span>
                    </div>
                    <div class="form-success hide" id="passwordSuccess" data-testid="new-password-success">
                      <i class="fas fa-check-circle"></i>
                      <span>Password is valid</span>
                    </div>
                  </div>

                  <div class="form-group-modern">
                    <label for="confirmPassword" class="form-label-modern">
                      <i class="fas fa-lock"></i>
                      Confirm Password
                    </label>
                    <input type="password" id="confirmPassword" name="confirmPassword" class="form-input-modern" placeholder="Confirm your new password" minlength="3" maxlength="50" data-testid="confirm-password-input" />
                    <div class="form-meta-modern">
                      <div class="form-help-modern">
                        <i class="fas fa-shield-alt"></i>
                        Re-enter password
                      </div>
                      <div class="char-counter-modern">
                        <span class="current" id="confirmPasswordCharCount">0</span>/50
                      </div>
                    </div>
                    <div class="form-error hide" id="confirmPasswordError" data-testid="confirm-password-error">
                      <i class="fas fa-exclamation-circle"></i>
                      <span id="confirmPasswordErrorText"></span>
                    </div>
                    <div class="form-success hide" id="confirmPasswordSuccess" data-testid="confirm-password-success">
                      <i class="fas fa-check-circle"></i>
                      <span>Passwords match</span>
                    </div>
                  </div>

                  <button type="submit" class="btn btn-futuristic btn-full-modern" data-testid="update-profile-submit-btn">
                    <i class="fas fa-save"></i>&nbsp;Save Changes
                  </button>
                </form>

                <div id="updateMessage" class="message-modern"></div>
              </div>
            </div>

            <!-- Danger Zone -->
            <div class="danger-zone-modern glass">
              <div class="card-header-modern danger-header">
                <h3>
                  <i class="fas fa-exclamation-triangle"></i>
                  Danger Zone
                </h3>
              </div>
              <div class="card-content-modern">
                <div class="danger-warning-modern">
                  <div class="danger-content-modern">
                    <h4>Delete Account</h4>
                    <p>
                      Permanently delete your account and all data. This
                      action cannot be undone.
                    </p>
                    <button id="deleteAccountBtn" class="btn btn-danger btn-compact" data-testid="delete-account-btn">
                      <i class="fas fa-trash"></i>
                      Delete Account
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Quick Actions -->
          <div class="quick-actions-modern">
            <a href="/staff-fields-main.html" class="btn btn-compact btn-futuristic"><i class="fas fa-link"></i> Staff & Fields Management</a>
            <a href="/" class="btn btn-compact btn-earth" data-testid="home-link">
              <i class="fas fa-home"></i>
              Home
            </a>
            </button>
          </div>
        </div>
      </div>
    </main>
    <!-- Dynamic Footer Component -->
    <div id="footer-component"></div>
  </div>
  <!-- Delete Account Modal -->
  <div id="deleteAccountModal" class="modal modal-centered" style="display: none">
    <div class="modal-content glass">
      <div class="modal-header">
        <h3>
          <i class="fas fa-exclamation-triangle"></i> Confirm Account Deletion
        </h3>
        <button class="modal-close" id="closeDeleteModal" aria-label="Close" data-testid="close-delete-modal">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <form class="update-form-modern modal-form" novalidate>
        <div class="modal-body">
          <div class="delete-warning">
            <p>
              <strong>Warning:</strong> This action is irreversible and will
              permanently delete your account.
            </p>
            <ul>
              <li>All your data will be permanently removed</li>
              <li>You will lose access to all services</li>
              <li>This action cannot be undone</li>
            </ul>
          </div>
          <div class="form-group-modern">
            <label for="deleteConfirmation" class="form-label-modern">
              <i class="fas fa-keyboard"></i> Type "DELETE" to confirm
            </label>
            <input type="text" id="deleteConfirmation" class="form-input-modern" placeholder="Type DELETE to confirm" maxlength="6" data-testid="delete-confirmation-input" />
            <div class="form-help-modern">
              <i class="fas fa-info-circle"></i>
              You must type "DELETE" exactly to confirm account deletion
            </div>
          </div>
        </div>
        <div class="modal-footer" style="display: flex; justify-content: flex-end; gap: 1rem">
          <button class="btn btn-earth btn-compact" id="cancelDelete" type="button" data-testid="cancel-delete-btn">
            <i class="fas fa-times"></i> Cancel
          </button>
          <button class="btn btn-danger btn-compact" id="confirmDelete" type="submit" disabled data-testid="confirm-delete-btn">
            <i class="fas fa-trash"></i> Delete Account
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Core Dependencies -->
  <script src="/js/core/event-bus.js"></script>
  <script src="/js/core/storage.js"></script>
  <script src="/js/core/app.js"></script>

  <!-- Services -->
  <script src="/js/services/api-service.js"></script>
  <script src="/js/services/auth-service.js"></script>

  <!-- Components -->
  <script src="/js/components/notification.js"></script>
  <script src="/js/components/navigation.js"></script>
  <script src="/js/components/form.js"></script>
  <script src="/js/components.js"></script>

  <!-- API Functions -->
  <script src="/js/api.js"></script>

  <!-- Utilities -->
  <script src="/js/utils/error-logger.js"></script>
  <script src="/js/utils/utils.js"></script>
  <script src="/js/utils/router.js"></script>
  <script src="/js/utils/global-compat.js"></script>

  <!-- Pages -->
  <script src="/js/pages/profile.js"></script>

  <!-- Main Application -->
  <script src="/js/app.js"></script>
  <script src="/js/utils/init-navigation.js"></script>
  <script>
    initNavigation("profile");
  </script>

  <script>
    // Initialize navigation after DOM is loaded
    document.addEventListener("DOMContentLoaded", async function () {
      // Test if ProfilePage class is available
      if (typeof ProfilePage !== "undefined") {
        // console.log("✅ ProfilePage class is available");
      } else {
        console.error("❌ ProfilePage class is NOT available");
      }

      // Test if App is available
      if (typeof window.App !== "undefined") {
        // console.log("✅ App is available");
      } else {
        console.error("❌ App is NOT available");
      }

      // Load the header component
      const headerElement = document.getElementById("header-component");
      if (headerElement) {
        try {
          const response = await fetch("/components/header.html");
          const html = await response.text();
          headerElement.innerHTML = html;

          // Initialize navigation after header is loaded
          if (typeof updateHeaderNav === "function") {
            // Check authentication status using standardized cookie names
            const token = getCookie("rolnopolToken");
            const isLogged = getCookie("rolnopolIsLogged");
            const username = getCookie("rolnopolUserLabel") || getCookie("rolnopolUsername");
            if (token && (isLogged === "true" || isLogged === true)) {
              try {
                const userData = await getUserInfo();
                updateHeaderNav(
                  userData.displayedName ||
                  userData.email ||
                  username ||
                  "User",
                );
              } catch (error) {
                console.error("Failed to get user info:", error);
                updateHeaderNav(username || "User");
              }
            } else {
              updateHeaderNav();
            }

            // Set active navigation link for profile page
            setActiveNavLink("profile");
          }
        } catch (error) {
          console.error("Failed to load header component:", error);
        }
      }

      // Load the footer component
      if (typeof initFooter === "function") {
        await initFooter();
      }
    });

    // Helper function to get cookie
    function getCookie(name) {
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if (parts.length === 2) return parts.pop().split(";").shift();
      return null;
    }
  </script>
</body>

</html>